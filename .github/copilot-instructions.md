# pfs-obslog2 開発ガイド

## プロジェクト概要

このプロジェクトは既存のpfs-obslogプロジェクト（`./old-project/codebase`が既存プロジェクトへのリンク）のリファクタリングです。

### 技術スタック

- **Backend:** FastAPI, SQLAlchemy
- **Frontend:** React, TypeScript, Vite, RTK Query

## 詳細ドキュメント

バックエンド・フロントエンドの詳細な開発情報は以下を参照してください：

- [バックエンド開発ガイド](../copilot/backend.md) - DB接続情報、開発コマンド、モデル生成など
- [フロントエンド開発ガイド](../copilot/frontend.md) - 開発コマンド、SCSS型生成、RTK Query API生成など
- [プロジェクトREADME](../README.md) - セットアップ手順、開発サーバーの起動方法

## 言語ポリシー

- **フロントエンド（ユーザー向けUI）:** 英語のみを使用してください
- **バックエンド（エラーメッセージ）:** ユーザーに伝わるエラーメッセージは英語を使用してください
- **コード内のコメント・ドキュメント:** 日本語でも英語でも可

## 自動生成ファイル

以下のファイルは自動生成されるため、直接編集しないでください：

- **`backend/src/pfs_obslog/models.py`**: `backend/devel/generate_models.py` によりDBスキーマから自動生成
- **`frontend/src/store/api/generatedApi.ts`**: OpenAPIスキーマから自動生成

## 作業について

以下を守ってください。

- ひとまとまりの作業が完了したらその作業についてのgit commitを行う。
- `git add -A` は使わない
  - 複数のエージェントが並行して動作していることがある。`-A` を使うと関係ないファイルもコミットしてしまう。
  - 代わりに `git add <ファイルパス>` で個別にステージングする。
- コマンド内で`>`は避ける（自動許可されないため）
- 指示者への確認は `./copilot/ask_for_instructions` を使用
  - 作業が進められない場合や各項目完了時のレビュー依頼に活用
- **バックエンド作業完了時には `make typecheck` で型チェックを実行する**
  - 型エラーがある場合は修正してからコミットする

## 機能の移植状況管理

バックエンドAPIの移植状況は [docs/migration/backend-api.md](../docs/migration/backend-api.md) で管理しています。
フロントエンドコンポーネントの移植状況は [docs/migration/frontend-components.md](../docs/migration/frontend-components.md) で管理しています。

### バックエンド移植状況の更新ルール

以下の場合は必ず `docs/migration/backend-api.md` を更新してください：

1. **新しいAPIエンドポイントを実装した場合**
   - 該当エンドポイントの「状態」を `⏳ 未実装` から `✅ 完了` に変更
   - 「新エンドポイント」欄にパスを記入
   - 必要に応じて「備考」を更新

2. **APIの実装を開始した場合**
   - 該当エンドポイントの「状態」を `🚧 作業中` に変更

3. **移行しないことが決定した場合**
   - 該当エンドポイントの「状態」を `❌ 移行しない` に変更
   - 「備考」に理由を記入

4. **サマリーテーブルの更新**
   - エンドポイントの状態を変更した際は、ページ上部のサマリーテーブルも更新

### フロントエンド移植状況の更新ルール

以下の場合は必ず `docs/migration/frontend-components.md` を更新してください：

1. **新しいコンポーネント/ページを実装した場合**
   - 該当コンポーネントの「状態」を `⏳ 未実装` から `✅ 完了` に変更
   - 「新コンポーネント」欄にパスを記入
   - 必要に応じて「備考」を更新

2. **部分的に実装が完了した場合**
   - 該当コンポーネントの「状態」を `🔶 一部完了` に変更
   - 未実装の機能を「備考」に記入

3. **コンポーネントの実装を開始した場合**
   - 該当コンポーネントの「状態」を `🚧 作業中` に変更

4. **移行しないことが決定した場合**
   - 該当コンポーネントの「状態」を `❌ 移行しない` に変更
   - 「備考」に理由を記入

5. **サマリーテーブルの更新**
   - コンポーネントの状態を変更した際は、ページ上部のサマリーテーブルも更新

### フィルター言語仕様書の更新ルール

フィルター言語の仕様は [docs/filter-language.md](../docs/filter-language.md) で管理しています。

以下のファイルを編集した場合は、必ず `docs/filter-language.md` も更新してください：

1. **`backend/src/pfs_obslog/visitquery/columns.py`**
   - 新しい仮想カラムを追加した場合 → 該当セクションにカラム定義を追加
   - カラム定義を変更した場合 → 対応する説明を更新
   - 集約カラムを追加した場合 → 「集約カラム」セクションを更新

2. **`backend/src/pfs_obslog/visitquery/evaluator.py`**
   - 新しい構文をサポートした場合 → 「サポートされる構文」セクションを更新
   - `_get_any_column_columns()` を変更した場合 → `any_column` の検索対象カラムを更新
   - 型キャストを追加した場合 → 「型キャスト」セクションを更新

3. **`backend/src/pfs_obslog/visitquery/parser.py`**
   - 許可する関数を変更した場合 → 「許可される関数」セクションを更新
   - セキュリティ制限を変更した場合 → 「セキュリティ制限」セクションを更新

4. **`backend/src/pfs_obslog/visitquery/joins.py`**
   - JOIN依存関係を変更した場合 → 「JOIN依存関係」セクションを更新
