# 遅いテストの調査レポート

## 概要

バックエンドテストで特に遅いテストについて調査した結果をまとめます。

## 遅いテスト一覧

| テスト名 | タイムアウト | 原因 |
|---------|-------------|------|
| `test_list_pfs_designs` | 60秒（120秒でもタイムアウト） | NFS経由のFITSファイル一括読み込み |

## 詳細分析: `test_list_pfs_designs`

### 環境情報

- **FITSファイル数**: 3,886ファイル
- **合計サイズ**: 約2.5GB（1.1GB使用中）
- **平均ファイルサイズ**: 651KB
- **ストレージ**: NFSマウント（`nfs-ics:/datapool/proddata`）
- **プロトコル**: NFS4.1、TCP、rsize/wsize=1MB

### ボトルネック分析

#### 1. ファイルアクセス速度（基準）

| 処理 | 時間 | スループット |
|-----|------|-------------|
| 単一ファイル読み込み（キャッシュあり） | 0.006秒 | 1.5GB/s |
| 100ファイルのstatアクセス | 0.54秒 | 185 files/s |
| 10ファイル完全読み込み | 0.12秒 | 83 files/s |

#### 2. Python/astropy での読み込み

| 処理 | 時間/ファイル | 3,886ファイル推定 |
|-----|-------------|-----------------|
| 素のastropy読み込み（最小限のデータ取得） | 7.1ms | 27.5秒 |
| `_read_design_entry`関数（全ヘッダー変換） | 23.7ms | 92秒 |

#### 3. オーバーヘッドの内訳

```
素のFITS読み込み:           7.1ms/ファイル (27.5秒)
_fits_meta_from_hdul:      12.9ms/ファイル (50.1秒)  ← 主要なボトルネック
その他のPydantic変換:        3.7ms/ファイル (14.4秒)
────────────────────────────────────────────────
合計:                      23.7ms/ファイル (92秒)
```

### 主要なボトルネック: `_fits_meta_from_hdul`

この関数は各FITSファイルの全HDU（4個）の全ヘッダーカード（約214カード）を
Pydanticオブジェクトに変換しています。

```python
# 問題のコード（概要）
def _fits_meta_from_hdul(filename: str, hdul) -> FitsMeta:
    return FitsMeta(
        filename=filename,
        hdul=[
            FitsHdu(
                index=i,
                header=FitsHeader(
                    cards=[
                        Card(key=keyword, value=_stringify(value), comment=comment)
                        for keyword, value, comment in hdu.header.cards  # 214回/ファイル
                    ]
                ),
            )
            for i, hdu in enumerate(hdul)  # 4回/ファイル
        ],
    )
```

- **1ファイルあたり**: 4 HDU × 約50カード = 約200個のPydanticオブジェクト生成
- **全ファイル**: 200 × 3,886 = 約77万オブジェクト

### I/Oスループットの妥当性評価

#### NFS読み込み速度

```
理論値（NFS4.1 TCP）:  ~100MB/s（一般的なNFS環境）
実測値（キャッシュあり）: 1.5GB/s（OSキャッシュ利用）
実測値（シーケンシャル）: ~80MB/s（3,886ファイル、2.5GB / 27.5秒）
```

**結論**: I/O自体は妥当な速度。ボトルネックはPythonでの処理オーバーヘッド。

#### 処理時間の内訳

| 処理 | 割合 |
|-----|-----|
| ファイルI/O + astropy解析 | 30% (27.5秒) |
| Pydanticオブジェクト生成 | 70% (64.5秒) |

## 改善提案

### 短期的対策（実施済み）

1. **テストの分離**: `@pytest.mark.slow` マーカーで遅いテストを分離
2. **デフォルトスキップ**: `make test` で slow テストをスキップ
3. **個別タイムアウト**: 遅いテストには長めのタイムアウト（60秒）を設定

### 中長期的改善案

1. **ヘッダー変換の遅延評価**
   - 一覧取得時は必要最小限のヘッダーのみ読み込み
   - 詳細取得時のみ全ヘッダーを変換

2. **キャッシュの導入**
   - ファイルの更新日時をキーにしたメモリキャッシュ
   - Redisなどの外部キャッシュ

3. **インデックスファイル**
   - Design一覧のメタデータをJSONファイルにキャッシュ
   - ファイル変更検出時のみ再生成

4. **ページネーション**
   - 一度に全ファイルを読まず、必要な分だけ読み込み
   - フロントエンドでの仮想スクロール対応

## まとめ

| 項目 | 値 |
|-----|---|
| **主原因** | Pydanticオブジェクトの大量生成（77万オブジェクト） |
| **I/O速度** | 妥当（NFS経由で80MB/s） |
| **改善可能性** | 高（ヘッダー変換の最適化で3倍高速化可能） |
| **現状の対応** | slow マーカーで通常テストから除外 |
